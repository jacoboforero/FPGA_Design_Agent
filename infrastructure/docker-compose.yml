# docker-compose.yml
# Description: Starts a RabbitMQ container for local development.
#
# Usage:
#   1. Save this file as 'docker-compose.yml'.
#   2. Save the corresponding 'rabbitmq-definitions.json' in the same directory.
#   3. Run 'docker-compose up -d' to start the service in the background.
#
version: "3.8"

services:
  rabbitmq:
    image: rabbitmq:3.11-management-alpine
    container_name: multi-agent-task-broker
    hostname: rabbitmq
    ports:
      # Port for AMQP client connections (from Orchestrator/Workers)
      - "5672:5672"
      # Port for the RabbitMQ Management UI
      - "15672:15672"
    volumes:
      # Mounts the definitions file to pre-configure exchanges, queues, and policies.
      # This is how we provision the broker declaratively.
      - ./rabbitmq-definitions.json:/etc/rabbitmq/definitions.json
      # Mount the configuration file to enable automatic definitions loading
      - ./rabbitmq.conf:/etc/rabbitmq/rabbitmq.conf
    environment:
      # Default user and password for the management UI and client connections.
      # For local development only. Do NOT use these credentials in production.
      - RABBITMQ_DEFAULT_USER=user
      - RABBITMQ_DEFAULT_PASS=password
  app:
    build:
      context: ..
      dockerfile: Dockerfile
      args:
        VERILATOR_VERSION: "5.044"
    container_name: fpga-design-agent
    working_dir: /workspace
    volumes:
      - ..:/workspace
      - poetry-cache:/root/.cache/pypoetry
      - pip-cache:/root/.cache/pip
    environment:
      - RABBITMQ_URL=amqp://user:password@rabbitmq:5672/
      - POETRY_CACHE_DIR=/root/.cache/pypoetry
      - PIP_CACHE_DIR=/root/.cache/pip
      - EDITOR=nano
    depends_on:
      - rabbitmq
    command: ["sleep", "infinity"]
    stdin_open: true
    tty: true

networks:
  default:
    name: multi-agent-network

volumes:
  poetry-cache:
  pip-cache:
